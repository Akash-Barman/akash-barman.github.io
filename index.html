<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Pro | Redesigned UI</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0D0E12;
            --bg-card: rgba(22, 24, 30, 0.6);
            --primary: #00FFA3;
            --secondary: #A450FF;
            --text-light: #F5F5F5;
            --text-dark: #8A8B92;
            --border-color: rgba(255, 255, 255, 0.1);
            --danger: #FF4D4D;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 15% 20%, rgba(164, 80, 255, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(0, 255, 163, 0.15) 0%, transparent 40%);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: -webkit-linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--text-dark);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto 25px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            max-width: 1300px;
            margin: 0 auto;
        }
        
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
        }
        
        .card h2 {
            color: var(--text-light);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.6rem;
            font-weight: 600;
        }
        
        .card h2 i {
            color: var(--primary);
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        button, .btn {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 255, 163, 0.2);
        }
        
        button:hover, .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(164, 80, 255, 0.4);
        }
        
        button:disabled, .btn:disabled {
            background: #2a2e37;
            cursor: not-allowed;
            box-shadow: none;
            color: var(--text-dark);
        }
        
        button.secondary, .btn.secondary {
            background: linear-gradient(90deg, #4a5568, #2d3748);
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        button.active-scan, .btn.active-scan {
            background: linear-gradient(90deg, var(--danger), #ff7878);
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
        }

        #connectWallet {
            grid-column: 1 / -1;
        }
        
        .status-container {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            margin-top: 20px;
            overflow-y: auto;
            max-height: 400px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }
        
        #result {
            white-space: pre-wrap;
            line-height: 1.8;
        }
        
        .warning {
            background-color: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 15px;
            border-radius: 12px;
            margin-top: 25px;
            font-size: 0.9rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .config-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .config-label {
            font-size: 0.85rem;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .config-value {
            font-weight: 500;
            font-size: 1rem;
            word-break: break-all;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        
        .progress {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 255, 163, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success { color: var(--primary); }
        .error { color: var(--danger); }
        .info { color: var(--text-light); }
        .warning-text { color: var(--warning); }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--text-light);
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .simulation-panel {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        .simulation-title {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .slippage-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }
        .slippage-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            width: 100px;
            text-align: right;
        }
        
        .debug-container {
            background-color: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
        }
        .tx-link {
            color: var(--primary);
            text-decoration: none;
        }
        .tx-link:hover {
            text-decoration: underline;
        }
        
        .execution-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            border-left: 4px solid;
        }
        .status-pending { border-color: var(--secondary); background-color: rgba(164, 80, 255, 0.1); }
        .status-confirmed { border-color: var(--primary); background-color: rgba(0, 255, 163, 0.1); }
        .status-failed { border-color: var(--danger); background-color: rgba(255, 77, 77, 0.1); }
        
        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 14, 18, 0.8);
            padding: 10px 20px;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            z-index: 100;
        }
        .version {
            text-align: center;
            color: var(--text-dark);
            font-size: 0.85rem;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: var(--text-dark);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }
        .copy-btn:hover {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <h1>Arbitrage Pro</h1>
        <div class="subtitle">
            Professional trading platform with direct execution, backtesting, and multi-DEX analysis on BNB Chain
        </div>
        <div id="libraryStatus" class="success"></div>
    </header>
    
    <div class="container">
        <div class="card">
            <h2><i class="fas fa-search"></i> Arbitrage Scanner</h2>
            <div class="controls">
                <button id="connectWallet">
                    <i class="fas fa-wallet"></i> Connect Wallet
                </button>
                 <button id="scanAll" disabled>
                    <i class="fas fa-search"></i> Scan All Combos
                </button>
                 <button id="autoScanToggle" disabled>
                    <i class="fas fa-robot"></i> Start Auto-Scan
                </button>
                 <button id="executeTrade" disabled class="secondary">
                    <i class="fas fa-bolt"></i> Execute Best Trade
                </button>
                 <button id="analyzeTrade" disabled class="secondary">
                    ✨ Analyze Opportunity
                </button>
            </div>
            
            <div class="simulation-panel">
                <div class="simulation-title"><i class="fas fa-cog"></i> Transaction Settings</div>
                
                <div class="slippage-control">
                    <span class="config-label">Flash Loan Amount (BNB):</span>
                    <input type="number" id="flashLoanInput" class="slippage-input" value="1.0" min="0.1" max="1000" step="0.1">
                </div>

                <div class="slippage-control" style="margin-top: 15px;">
                    <span class="config-label">Min Profit %:</span>
                    <input type="number" id="minProfitInput" class="slippage-input" value="1.0" min="0.1" max="100" step="0.1">
                </div>
                
                <div class="slippage-control">
                    <span class="config-label">Slippage Tolerance %:</span>
                    <input type="number" id="slippageInput" class="slippage-input" value="1.0" min="0.1" max="50" step="0.1">
                </div>

                <div class="slippage-control">
                    <span class="config-label">Max Gas Fee (BNB):</span>
                    <input type="number" id="maxGasFeeInput" class="slippage-input" value="0.005" min="0.0001" step="0.0001">
                </div>
            </div>
            
            <div id="geminiAnalysisContainer" class="simulation-panel" style="display:none; border-color: var(--secondary);">
                 <div class="simulation-title">✨ AI Opportunity Analysis</div>
                 <div id="geminiAnalysisResult" style="line-height: 1.6;"></div>
            </div>

            <div class="progress-container">
                <div class="progress-label">
                    <span>Scan Progress</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="scanProgress"></div>
                </div>
            </div>
            
            <div class="status-container">
                <div id="result">[System] Welcome to Arbitrage Pro! Please connect your wallet to begin.</div>
            </div>
            
            <div class="debug-container" id="debugInfo">
                <div class="simulation-title"><i class="fas fa-code"></i> Transaction Execution</div>
                <div id="executionResult">No transaction data available</div>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-cogs"></i> Configuration & Status</h2>
            
            <div class="contract-section">
                <div class="config-item">
                    <div class="config-label">Contract Address</div>
                    <div class="config-value">
                        <span id="contractAddress">...</span>
                        <button id="copyContractBtn" class="copy-btn"><i class="far fa-copy"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="config-grid">
                <div class="config-item">
                    <div class="config-label">Gas Price</div>
                    <div class="config-value" id="gasPriceDisplay">--</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Network</div>
                    <div class="config-value">BNB Chain</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Wallet Status</div>
                    <div class="config-value" id="walletStatus">Not Connected</div>
                </div>
                <div class="config-item">
                    <div class="config-label">DEXs Active</div>
                    <div class="config-value" id="dexesActive">12</div>
                </div>
            </div>

            <div class="section-title"><i class="fas fa-history"></i> Backtesting Tool</div>
            <div class="simulation-panel">
                <div class="simulation-title"><i class="fas fa-chart-bar"></i> Historical Data Analysis (Simulated)</div>
                <div class="config-item">
                    <div class="config-label">Time Range</div>
                    <select id="backtestTimeRange" class="token-input">
                        <option value="1">Last 1 hour</option>
                        <option value="6">Last 6 hours</option>
                        <option value="24" selected>Last 24 hours</option>
                        <option value="168">Last 7 days</option>
                    </select>
                </div>
                <button id="runBacktest" class="btn" style="width: 100%;">
                    <i class="fas fa-play-circle"></i> Run Backtest
                </button>
                 <div id="backtestResults" class="simulation-result" style="display:none;"></div>
            </div>

            <div class="section-title"><i class="fas fa-exchange-alt"></i> Multi-DEX Analysis</div>
            <div class="simulation-panel">
                 <div class="simulation-title"><i class="fas fa-balance-scale"></i> Compare Prices Across DEXs (Simulated)</div>
                <div class="token-input-row">
                    <div class="token-input-label" style="min-width: 50px;">Token:</div>
                    <select id="dexTokenSelect" class="token-input">
                        <option value="WBNB">WBNB</option>
                        <option value="BUSD">BUSD</option>
                        <option value="USDT">USDT</option>
                        <option value="ETH">ETH</option>
                        <option value="CAKE">CAKE</option>
                        <option value="BTCB">BTCB</option>
                    </select>
                </div>
                <button id="comparePrices" class="btn" style="width: 100%;">
                    <i class="fas fa-search-dollar"></i> Compare Prices
                </button>
                <div id="dexComparison" class="status-container" style="margin-top:15px; display:none; min-height: auto; max-height: 250px;">
                </div>
            </div>

            <div class="controls" style="margin-top: 25px;">
                <button id="viewContract">
                    <i class="fas fa-file-contract"></i> View Contract on BscScan
                </button>
            </div>
        </div>
    </div>

    <div class="fixed-bottom">
        <div class="version">Arbitrage Pro v5.1 | Redesigned UI</div>
    </div>

    <script>
        const RAW_CONTRACT_ADDRESS = "0x4673fb316EaD2f9a9C1C8A9b40484384d55360De"; 
        let MIN_PROFIT_THRESHOLD = 1.0;
        let FLASH_LOAN_AMOUNT = 1.0; 
        let SLIPPAGE_TOLERANCE = 1.0; 
        let MAX_GAS_FEE = 0.005;

        function toChecksumAddress(address) {
            try { return ethers.utils.getAddress(address.toLowerCase()); } catch { return null; }
        }

        const CONTRACT_ABI = ["function executeArbitrage(address,uint256,address[],address[])", "function owner() view returns (address)"];

        const TOKENS = {
            WBNB: { address: toChecksumAddress("0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c"), decimals: 18, symbol: 'WBNB' },
            BUSD: { address: toChecksumAddress("0xe9e7cea3dedca5984780bafc599bd69add087d56"), decimals: 18, symbol: 'BUSD' },
            USDT: { address: toChecksumAddress("0x55d398326f99059ff775485246999027b3197955"), decimals: 18, symbol: 'USDT' },
            ETH:  { address: toChecksumAddress("0x2170ed0880ac9a755fd29b2688956bd959f933f8"), decimals: 18, symbol: 'ETH' },
            BTCB: { address: toChecksumAddress("0x7130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c"), decimals: 18, symbol: 'BTCB' },
            CAKE: { address: toChecksumAddress("0x0e09fabb73bd3ade0a17ecc321fd13a19e81ce82"), decimals: 18, symbol: 'CAKE' },
            LINK: { address: toChecksumAddress("0xf8a0bf9cf54bb92fb173938622107ae6a24aa565"), decimals: 18, symbol: 'LINK' },
            DOT:  { address: toChecksumAddress("0x7083609fce4d1d8dc0c979aab8c869ea2c873402"), decimals: 18, symbol: 'DOT' },
            XRP:  { address: toChecksumAddress("0x1d2f0da166d9222b81948da16d7999c348c14c8c"), decimals: 18, symbol: 'XRP'  },
            LTC:  { address: toChecksumAddress("0x4338665cbb7b2485a8855a139b75d5e34ab0db94"), decimals: 18, symbol: 'LTC'  },
            TRX:  { address: toChecksumAddress("0x85eac5ac2f758618dfa0926797919861b2714a51"), decimals: 18, symbol: 'TRX'  },
            UNI:  { address: toChecksumAddress("0xbf5140a255dc56728e6024e4e8bf83238d23e387"), decimals: 18, symbol: 'UNI'  },
            SOL:  { address: toChecksumAddress("0x570a5d26f7765ecb712c0924e4de545b89fd43df"), decimals: 18, symbol: 'SOL'  },
            AVAX: { address: toChecksumAddress("0x1ce0c2827e2ef14d5c4f29a091d735a204794041"), decimals: 18, symbol: 'AVAX' },
            FTM:  { address: toChecksumAddress("0xad29abb318791d579433d831ed122afeaf29dcfe"), decimals: 18, symbol: 'FTM'  }
        };
        
        const DEXS = {
            PancakeSwap: { router: toChecksumAddress('0x10ED43C718714eb63d5aA57B78B54704E256024E'), factory: toChecksumAddress('0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73'), type: 'v2' },
            PancakeSwapV3: { router: toChecksumAddress('0x1b81D678ffb9C0263b24A97847620C99d213eB14'), quoter: toChecksumAddress('0xB048Bbc1Ee4b786228dE3362434b472480479241'), factory: toChecksumAddress('0x0BFbCF9fa4f9C56B0F40a671AD41E12991081683'), type: 'v3', fee: 2500},
            ApeSwap: { router: toChecksumAddress('0xcF0feBd3f17CEf5b47b0cD257aCf6025c5BFf3b7'), factory: toChecksumAddress('0x0841BD0B734E4F5853f0dD8d7Ea041c241fb0Da6'), type: 'v2' },
            BiSwap: { router: toChecksumAddress('0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8'), factory: toChecksumAddress('0x858E3312ed3A876947EA49d572A7C42DE08af7EE'), type: 'v2' },
            SushiSwap: { router: toChecksumAddress('0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506'), factory: toChecksumAddress('0xc35DADB65012eC5796536bD9864eD8773aBc74C4'), type: 'v2' },
            BabyDogeSwap: { router: toChecksumAddress('0xCBe6C2f275429354395355555555555555555555'), factory: toChecksumAddress('0x83595C33527161b3b194551105948011215C5328'), type: 'v2'},
            MDEX: { router: toChecksumAddress('0x7DAe51BD3E3376B8c7c4900E9107f12Be3AF1bA8'), factory: toChecksumAddress('0x3CD1C46062d140A2167352266b943266b3062366'), type: 'v2'},
            BakerySwap: { router: toChecksumAddress('0x3253a9C35465620844215038559624542E754C8E'), factory: toChecksumAddress('0x01bF7C66c6BD861915CdaaE475042D3c4BaE16A7'), type: 'v2'},
            KnightSwap: { router: toChecksumAddress('0x05E61E0722361952206d52542B47230467149793'), factory: toChecksumAddress('0x242A585F8B833f48269734A232a2402127393444'), type: 'v2'},
            UniswapBSC: { router: toChecksumAddress('0x8909Dc15e40173Ff4699343b6eB8132c65e18eC6'), factory: toChecksumAddress('0x0BFbCF9fa4f9C56B0F40a671AD41E12991081683'), type: 'v2' },
            OpenOcean: { router: toChecksumAddress('0x6352a56caadC4F1E25CD6c75970Fa768A3304e64'), type: 'aggregator' },
            WOOFi: { router: toChecksumAddress('0x222222222285a87462445e993865a7322e5A9b6b'), type: 'aggregator' }
        };
        
        const V2_ROUTER_ABI = ['function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'];
        const V3_QUOTER_ABI = ['function quoteExactInputSingle(address tokenIn, address tokenOut, uint24 fee, uint256 amountIn, uint160 sqrtPriceLimitX96) external view returns (uint256 amountOut)'];

        let provider, signer, contract;
        let currentOpportunity = null;
        let isAutoScanning = false;
        let isManualScanning = false;
        let failedScanCycles = 0;
        let alertOscillator = null;
        let alertInterval = null;

        document.addEventListener('DOMContentLoaded', setupUI);

        function setupUI() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('scanAll').addEventListener('click', () => {
                const allPaths = generateAllPaths();
                scanForOpportunities(allPaths);
            });
            document.getElementById('executeTrade').addEventListener('click', () => executeTrade(currentOpportunity));
            document.getElementById('analyzeTrade').addEventListener('click', analyzeOpportunity);
            document.getElementById('viewContract').addEventListener('click', viewContract);
            document.getElementById('autoScanToggle').addEventListener('click', toggleAutoScanner);
            document.getElementById('slippageInput').addEventListener('change', (e) => { SLIPPAGE_TOLERANCE = parseFloat(e.target.value); logMessage(`Slippage set to ${SLIPPAGE_TOLERANCE}%`); });
            document.getElementById('minProfitInput').addEventListener('change', (e) => { MIN_PROFIT_THRESHOLD = parseFloat(e.target.value); logMessage(`Min Profit set to ${MIN_PROFIT_THRESHOLD}%`); });
            document.getElementById('flashLoanInput').addEventListener('change', (e) => { FLASH_LOAN_AMOUNT = parseFloat(e.target.value); logMessage(`Flash Loan set to ${FLASH_LOAN_AMOUNT} BNB`); });
            document.getElementById('maxGasFeeInput').addEventListener('change', (e) => { MAX_GAS_FEE = parseFloat(e.target.value); logMessage(`Max Gas Fee set to ${MAX_GAS_FEE} BNB`); });
            document.getElementById('copyContractBtn').addEventListener('click', copyContractAddress);
            
            const checksummedAddr = toChecksumAddress(RAW_CONTRACT_ADDRESS);
            document.getElementById('checksumStatus').textContent = checksummedAddr ? '✅ Valid' : '❌ Invalid';
            document.getElementById('checksumStatus').className = checksummedAddr ? 'success' : 'error';
            document.getElementById('dexesActive').textContent = Object.keys(DEXS).length;
            document.getElementById('contractAddress').textContent = `${RAW_CONTRACT_ADDRESS.substring(0, 6)}...${RAW_CONTRACT_ADDRESS.substring(RAW_CONTRACT_ADDRESS.length - 4)}`;
        }

        function copyContractAddress() {
            navigator.clipboard.writeText(RAW_CONTRACT_ADDRESS).then(() => {
                logMessage('Contract address copied to clipboard');
            });
        }

        function startAlert() {
            if (alertInterval) return;
            if (!alertOscillator) {
                alertOscillator = new Tone.Oscillator({ type: "square", frequency: "C5", volume: -12 }).toDestination();
            }
            if (Tone.context.state !== 'running') { Tone.start(); }
            alertInterval = setInterval(() => { alertOscillator.start().stop("+0.1"); }, 400);
        }

        function stopAlert() {
            if (alertInterval) {
                clearInterval(alertInterval);
                alertInterval = null;
                if(alertOscillator && alertOscillator.state === "started") { alertOscillator.stop(); }
            }
        }
        
        function stopAutoScan(wasCancelledByUser) {
             isAutoScanning = false;
             const autoScanBtn = document.getElementById('autoScanToggle');
             const scanAllBtn = document.getElementById('scanAll');
             if(!isManualScanning) scanAllBtn.disabled = false;
             autoScanBtn.innerHTML = '<i class="fas fa-robot"></i> Start Auto-Scan';
             autoScanBtn.classList.remove('active-scan');
             if(wasCancelledByUser) {
                logMessage('Auto-scanner stopped.');
                stopAlert();
             }
        }

        function toggleAutoScanner() {
            const autoScanBtn = document.getElementById('autoScanToggle');
            const scanAllBtn = document.getElementById('scanAll');

            if (!isAutoScanning) {
                isAutoScanning = true;
                failedScanCycles = 0;
                scanAllBtn.disabled = true;
                autoScanBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Scan';
                autoScanBtn.classList.add('active-scan');
                logMessage('Auto-scanner started. Searching for first profitable opportunity...');
                findFirstOpportunity();
            } else {
                 stopAutoScan(true);
            }
        }
        
        function adjustScanParameters() {
            logMessage(`No opportunities found after 3 cycles. Adjusting parameters...`, false, true);
            MIN_PROFIT_THRESHOLD = Math.max(0.2, MIN_PROFIT_THRESHOLD - 0.1);
            document.getElementById('minProfitInput').value = MIN_PROFIT_THRESHOLD.toFixed(1);
            logMessage(`New Min Profit: ${MIN_PROFIT_THRESHOLD.toFixed(1)}%`);
            FLASH_LOAN_AMOUNT = Math.min(50, FLASH_LOAN_AMOUNT * 1.25);
            document.getElementById('flashLoanInput').value = FLASH_LOAN_AMOUNT.toFixed(2);
            logMessage(`New Flash Loan Amount: ${FLASH_LOAN_AMOUNT.toFixed(2)} BNB`);
            failedScanCycles = 0;
        }

        async function findFirstOpportunity() {
            while (isAutoScanning) {
                const allPaths = generateAllPaths();
                const opportunity = await scanForOpportunities(allPaths, true);
                if (opportunity) {
                    logMessage(`Opportunity found! Auto-scan stopped.`, false);
                    startAlert();
                    stopAutoScan(false);
                    break;
                }
                if (isAutoScanning) {
                    failedScanCycles++;
                    if (failedScanCycles >= 3) {
                        adjustScanParameters();
                    }
                    logMessage(`No opportunities found. Retrying in 5 seconds...`, false, true);
                    await new Promise(res => setTimeout(res, 5000));
                }
            }
        }

        function generateAllPaths() {
            const allTokens = Object.values(TOKENS);
            const baseToken = TOKENS.WBNB;
            const otherTokens = allTokens.filter(t => t.address && t.address.toLowerCase() !== baseToken.address.toLowerCase());
            const dexKeys = Object.keys(DEXS);
            const paths = [];

            for (const tokenA of otherTokens) {
                for (const tokenB of otherTokens) {
                    if (tokenA.address === tokenB.address) continue;
                    for (const dex1 of dexKeys) {
                        for (const dex2 of dexKeys) {
                             paths.push({
                                tokenPath: [baseToken, tokenA, tokenB, baseToken],
                                dexFactories: [DEXS[dex1].factory, DEXS[dex2].factory],
                                dexes: [DEXS[dex1], DEXS[dex2]],
                                name: `${baseToken.symbol}→${tokenA.symbol}(${dex1})→${tokenB.symbol}(${dex2})`
                            });
                        }
                    }
                }
            }
            return paths;
        }

        async function getAmountOutFromDex(amountIn, path, dexInfo) {
            try {
                if (dexInfo.type === 'v3') {
                    const quoter = new ethers.Contract(dexInfo.quoter, V3_QUOTER_ABI, provider);
                    return await quoter.quoteExactInputSingle(path[0].address, path[1].address, dexInfo.fee, amountIn, 0);
                } else {
                    const router = new ethers.Contract(dexInfo.router, V2_ROUTER_ABI, provider);
                    const amounts = await router.getAmountsOut(amountIn, path.map(t => t.address));
                    return amounts[amounts.length - 1];
                }
            } catch (e) {
                return ethers.BigNumber.from(0);
            }
        }
        
        async function scanForOpportunities(pathsToScan, stopOnFirst = false) {
            if (!signer) {
                 logMessage("Please connect wallet first.", true);
                 stopAutoScan(false);
                 return null;
            }

            stopAlert();
            document.getElementById('geminiAnalysisContainer').style.display = 'none';
            isManualScanning = !stopOnFirst;
            logMessage(`Scanning ${pathsToScan.length} total possible paths... (This may take a while)`);
            if (!isAutoScanning) document.getElementById('scanAll').disabled = true;
            document.getElementById('executeTrade').disabled = true;
            document.getElementById('analyzeTrade').disabled = true;
            updateProgress(0);

            const checkPath = async (pathInfo) => {
                 try {
                    if (!isAutoScanning && !isManualScanning) return null;
                    const amountIn = ethers.utils.parseUnits(FLASH_LOAN_AMOUNT.toString(), pathInfo.tokenPath[0].decimals);
                    
                    let currentAmount = amountIn;
                    currentAmount = await getAmountOutFromDex(currentAmount, [pathInfo.tokenPath[0], pathInfo.tokenPath[1]], pathInfo.dexes[0]);
                    if (currentAmount.isZero()) return null;

                    currentAmount = await getAmountOutFromDex(currentAmount, [pathInfo.tokenPath[1], pathInfo.tokenPath[2]], pathInfo.dexes[1]);
                    if (currentAmount.isZero()) return null;

                    let finalAmountOut = await getAmountOutFromDex(currentAmount, [pathInfo.tokenPath[2], pathInfo.tokenPath[3]], DEXS.PancakeSwap);
                    if (finalAmountOut.isZero()) return null;

                    const slippageFactor = (100 - SLIPPAGE_TOLERANCE) / 100;
                    const minAmountOut = finalAmountOut.mul(Math.floor(slippageFactor * 10000)).div(10000);
                    const profit = minAmountOut.sub(amountIn);

                    if (profit.gt(0)) {
                        const profitPercentage = (profit.mul(10000).div(amountIn)).toNumber() / 100;
                        if (profitPercentage > MIN_PROFIT_THRESHOLD) {
                             const isV3Path = pathInfo.dexes.some(d => d.type === 'v3');
                            return { profit: profitPercentage, path: pathInfo.tokenPath.map(p => p.address), dexes: pathInfo.dexFactories.filter(f=>f), name: pathInfo.name, amountIn, isV3Path };
                        }
                    }
                } catch(e) { return null; }
                return null;
            };

            let bestOpportunity = { profit: -Infinity };
            let pathsChecked = 0;
            const chunkSize = 50; 
            for (let i = 0; i < pathsToScan.length; i += chunkSize) {
                if (stopOnFirst && bestOpportunity.profit > MIN_PROFIT_THRESHOLD) break;
                if(!isAutoScanning && !isManualScanning) break;

                const chunk = pathsToScan.slice(i, i + chunkSize);
                const promises = chunk.map(p => checkPath(p));
                const results = await Promise.all(promises);

                pathsChecked += chunk.length;

                for (const opportunity of results) {
                    if (opportunity && opportunity.profit > bestOpportunity.profit) {
                        bestOpportunity = opportunity;
                    }
                }
                if(!stopOnFirst) updateProgress((pathsChecked / pathsToScan.length) * 100);
            }
            
            if (bestOpportunity.profit > MIN_PROFIT_THRESHOLD) {
                logMessage(`SUCCESS: New best opportunity found! Path: ${bestOpportunity.name} Profit: ${bestOpportunity.profit.toFixed(4)}%`, false);
                currentOpportunity = bestOpportunity;
                document.getElementById('analyzeTrade').disabled = false;
                if (bestOpportunity.isV3Path) {
                    logMessage("V3 path found. Manual execution required via a V3-compatible contract.", false, true);
                    document.getElementById('executeTrade').disabled = true;
                } else {
                    document.getElementById('executeTrade').disabled = false;
                }

                if (stopOnFirst) return bestOpportunity;
                startAlert();
            } else if (!stopOnFirst) {
                logMessage("Scan complete. No profitable opportunities found.", false, true);
            }
            
            if (!isAutoScanning) {
                document.getElementById('scanAll').disabled = false;
                isManualScanning = false;
            }
            return null;
        }

        async function analyzeOpportunity() {
            if (!currentOpportunity) {
                logMessage('No opportunity to analyze.', true);
                return;
            }
            logMessage('Analyzing opportunity with Gemini AI...');
            stopAlert();
            const analysisContainer = document.getElementById('geminiAnalysisContainer');
            const analysisResultDiv = document.getElementById('geminiAnalysisResult');
            analysisContainer.style.display = 'block';
            analysisResultDiv.innerHTML = '<div class="spinner"></div>';

            const prompt = `You are a DeFi trading analyst. An arbitrage opportunity was found on the BNB Smart Chain. Here are the details:
- Path: ${currentOpportunity.name}
- Estimated Profit: ${currentOpportunity.profit.toFixed(4)}%
- Flash Loan Amount: ${ethers.utils.formatEther(currentOpportunity.amountIn)} BNB

Please provide a brief, one-paragraph risk and opportunity analysis for a human trader. Mention the volatility of the tokens involved (e.g., stablecoins vs. altcoins), the complexity of the path, and a general assessment of the risk level (e.g., Low, Medium, High). Keep the tone professional but easy to understand.`;
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    analysisResultDiv.textContent = text;
                } else {
                    throw new Error('Invalid response structure from Gemini API.');
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                analysisResultDiv.textContent = 'Could not retrieve analysis. Please try again.';
                logMessage('Failed to get analysis from Gemini AI.', true);
            }
        }


        async function executeTrade(opportunityToExecute) {
            if (!opportunityToExecute) return logMessage("No opportunity provided to execute.", true);
            if (opportunityToExecute.isV3Path) return logMessage("Cannot execute V3 path with this contract.", true);
            stopAlert();
            document.getElementById('geminiAnalysisContainer').style.display = 'none';
            logMessage(`Preparing to execute: ${opportunityToExecute.name}`);
            const executeBtn = document.getElementById('executeTrade');
            executeBtn.disabled = true;
            document.getElementById('executionResult').innerHTML = `<div class="execution-status status-pending"><i class="fas fa-cogs"></i> Estimating gas fee...</div>`;

            try {
                const gasPrice = await provider.getGasPrice();
                document.getElementById('gasPriceDisplay').textContent = `${parseFloat(ethers.utils.formatUnits(gasPrice, 'gwei')).toFixed(2)} Gwei`;
                
                const estimatedGasLimit = await contract.estimateGas.executeArbitrage(opportunityToExecute.path[0], opportunityToExecute.amountIn, opportunityToExecute.path, opportunityToExecute.dexes);
                const gasLimit = estimatedGasLimit.mul(120).div(100);
                const totalGasFee = gasPrice.mul(gasLimit);
                const feeInBnb = ethers.utils.formatEther(totalGasFee);

                if (totalGasFee.gt(ethers.utils.parseEther(MAX_GAS_FEE.toString()))) {
                    throw new Error(`Estimated gas fee (${feeInBnb} BNB) exceeds your max setting of ${MAX_GAS_FEE} BNB.`);
                }

                logMessage(`Estimated network fee: ${feeInBnb} BNB. Please confirm in your wallet.`);
                document.getElementById('executionResult').innerHTML = `<div class="execution-status status-pending"><i class="fas fa-fire"></i> Estimated Fee: <strong>${parseFloat(feeInBnb).toFixed(8)} BNB</strong></div><div class="execution-status status-pending" style="margin-top: 5px;"><i class="fas fa-wallet"></i> Waiting for wallet confirmation...</div>`;

                const tx = await contract.executeArbitrage(opportunityToExecute.path[0], opportunityToExecute.amountIn, opportunityToExecute.path, opportunityToExecute.dexes, { gasPrice, gasLimit });
                logMessage(`Transaction sent with hash: ${tx.hash}`);
                document.getElementById('executionResult').innerHTML = `<div class="execution-status status-pending"><i class="fas fa-hourglass-half"></i> Tx Sent: <a href="https://bscscan.com/tx/${tx.hash}" target="_blank" class="tx-link">${tx.hash}</a></div>`;
                
                const receipt = await tx.wait();
                const actualFee = receipt.gasUsed.mul(receipt.effectiveGasPrice);

                if (receipt.status === 1) {
                    logMessage("SUCCESS: Arbitrage transaction confirmed!", false);
                    document.getElementById('executionResult').innerHTML = `<div class="execution-status status-confirmed"><i class="fas fa-check-circle"></i> Tx Confirmed in block: ${receipt.blockNumber}</div><div class="execution-status status-confirmed" style="margin-top: 5px;"><i class="fas fa-gas-pump"></i> Actual Fee Paid: ${ethers.utils.formatEther(actualFee)} BNB</div>`;
                } else {
                    throw new Error(`Transaction failed on-chain with status 0. Hash: ${receipt.transactionHash}`);
                }
            } catch(e) {
                let errorMessage = e.reason || e.message || 'An unknown error occurred.';
                logMessage(`Trade execution failed: ${errorMessage}`, true);
                if (e.code === 'INSUFFICIENT_FUNDS') errorMessage = '<strong>Execution Failed:</strong> Insufficient BNB balance for gas fees.';
                else if (e.code === 4001) errorMessage = '<strong>Transaction Rejected:</strong> You rejected the transaction in your wallet.';
                else if (errorMessage.includes('execution reverted')) errorMessage = `<strong>Execution Failed:</strong> The contract rejected the transaction. This usually means market conditions changed and the trade is no longer profitable.`;
                document.getElementById('executionResult').innerHTML = `<div class="execution-status status-failed"><i class="fas fa-times-circle"></i> ${errorMessage}</div>`;
                if (e.transactionHash) document.getElementById('executionResult').innerHTML += `<div class="execution-status status-failed">Tx Hash: <a href="https://bscscan.com/tx/${e.transactionHash}" target="_blank" class="tx-link">${e.transactionHash}</a></div>`;
            } finally {
                executeBtn.disabled = false;
            }
        }
        
        async function connectWallet() {
            if (!window.ethereum) return logMessage("MetaMask not detected.", true);
            logMessage("Connecting wallet...");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                if (network.chainId !== 56) return logMessage("Warning: Not on BNB Chain.", true);
                
                signer = provider.getSigner();
                contract = new ethers.Contract(toChecksumAddress(RAW_CONTRACT_ADDRESS), CONTRACT_ABI, signer);
                
                document.getElementById('walletStatus').textContent = "Connected";
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('scanAll').disabled = false;
                document.getElementById('autoScanToggle').disabled = false;
                logMessage("Wallet connected successfully.", false);
            } catch(e) {
                logMessage(`Connection failed: ${e.message}`, true);
            }
        }
        
        function viewContract() { window.open(`https://bscscan.com/address/${toChecksumAddress(RAW_CONTRACT_ADDRESS)}`, '_blank'); }
        function logMessage(message, isError = false, isWarning = false) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'info';
            if (isError) colorClass = 'error';
            else if (isWarning) colorClass = 'warning-text';
            resultDiv.innerHTML = `<div style="margin-bottom: 5px;">[${timestamp}] <span class="${colorClass}">${message}</span></div>` + resultDiv.innerHTML;
        }
        function updateProgress(percent) {
            const progress = Math.min(100, Math.round(percent));
            document.getElementById('scanProgress').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${progress}%`;
        }

        // SIMULATED FUNCTIONS
        async function runBacktest() { logMessage("Backtesting is a simulated feature."); }
        async function compareDexPrices() { logMessage("DEX Comparison is a simulated feature."); }
    </script>
</body>
</html>
